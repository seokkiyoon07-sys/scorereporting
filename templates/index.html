<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", "Malgun Gothic", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #ebebeb;
            border-color: #667eea;
        }

        .file-input-label.has-file {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .subject-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .subject-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .subject-item label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .file-name {
            font-weight: 500;
        }

        .file-item .download-btn {
            padding: 6px 15px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .file-item .download-btn:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .subject-list {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì„±ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>í•™ìƒ ì„±ì  ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ì„±ì í‘œë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
        </div>

        <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
        <div id="alert" class="alert"></div>

        <!-- ì§„í–‰ë¥  í‘œì‹œ -->
        <div id="progress" class="progress">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>

        <!-- ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¹´ë“œ -->
        <div class="card">
            <h2>ğŸ“¥ ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h2>
            <p style="color: #666; margin-bottom: 20px;">
                ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”? ì•„ë˜ ìƒ˜í”Œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                <a href="/download-sample/sample_students.csv" class="btn btn-success" style="text-decoration: none; text-align: center; display: block;">
                    âœ¨ í•™ìƒëª… ìƒ˜í”Œ (í•„ìˆ˜)
                </a>
                <a href="/download-sample/sample_grade_cutoff.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    â­ ë“±ê¸‰ì»· ìƒ˜í”Œ (ì„ íƒ)
                </a>
                <a href="/download-sample/sample_korean.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    ğŸ“„ êµ­ì–´ ìƒ˜í”Œ
                </a>
                <a href="/download-sample/sample_math.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    ğŸ“ ìˆ˜í•™ ìƒ˜í”Œ
                </a>
                <a href="/download-sample/sample_english.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    ğŸ”¤ ì˜ì–´ ìƒ˜í”Œ
                </a>
                <a href="/download-sample/sample_history.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    ğŸ“œ í•œêµ­ì‚¬ ìƒ˜í”Œ
                </a>
                <a href="/download-sample/sample_inquiry.csv" class="btn btn-primary" style="text-decoration: none; text-align: center; display: block;">
                    ğŸ”¬ íƒêµ¬ ìƒ˜í”Œ (í†µí•©)
                </a>
            </div>
        </div>

        <!-- ì„¤ì • ì¹´ë“œ -->
        <div class="card">
            <h2>ğŸ“ ì„±ì í‘œ ì„¤ì •</h2>
            <div class="form-group">
                <label for="pdf_title">ì„±ì í‘œ ì œëª©</label>
                <input type="text" id="pdf_title" placeholder="ì˜ˆ: 2024í•™ë…„ë„ 10ì›” ëª¨ì˜ê³ ì‚¬" value="ëª¨ì˜ê³ ì‚¬ ì„±ì í‘œ">
            </div>
            <div class="form-group">
                <label for="exam_name">ì‹œí—˜ íšŒì°¨</label>
                <input type="text" id="exam_name" placeholder="ì˜ˆ: 10ì›” ëª¨ì˜ê³ ì‚¬" value="2024í•™ë…„ë„ ëª¨ì˜ê³ ì‚¬">
            </div>
        </div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ -->
        <div class="card">
            <h2>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</h2>
            
            <!-- í•™ìƒëª… íŒŒì¼ (í•„ìˆ˜) -->
            <div class="form-group">
                <label for="student_names">í•™ìƒëª… íŒŒì¼ âœ¨ (í•„ìˆ˜)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="student_names" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'student_names_label')">
                    <label for="student_names" class="file-input-label" id="student_names_label">
                        ğŸ“„ íŒŒì¼ ì„ íƒ (CSV ë˜ëŠ” Excel)
                    </label>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    í˜•ì‹: ìˆ˜í—˜ë²ˆí˜¸, ì´ë¦„
                </small>
            </div>
            
            <!-- ë“±ê¸‰ì»· íŒŒì¼ (ì„ íƒì‚¬í•­) -->
            <div class="form-group">
                <label for="grade_cutoff">ë“±ê¸‰ì»· íŒŒì¼ â­ (ì„ íƒì‚¬í•­)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="grade_cutoff" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'grade_cutoff_label')">
                    <label for="grade_cutoff" class="file-input-label" id="grade_cutoff_label">
                        ğŸ“„ íŒŒì¼ ì„ íƒ (CSV ë˜ëŠ” Excel) - ì„ íƒì‚¬í•­
                    </label>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    ë“±ê¸‰ì»· ì •ë³´ê°€ ì—†ì–´ë„ ì„±ì í‘œ ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤
                </small>
            </div>

            <!-- ê³¼ëª© íŒŒì¼ë“¤ -->
            <div class="form-group">
                <label>ê³¼ëª©ë³„ ì„±ì  íŒŒì¼</label>
                <div class="subject-list">
                    <div class="subject-item">
                        <label for="subject_korean">êµ­ì–´</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="subject_korean" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'korean_label')">
                            <label for="subject_korean" class="file-input-label" id="korean_label">ğŸ“„ íŒŒì¼ ì„ íƒ</label>
                        </div>
                    </div>

                    <div class="subject-item">
                        <label for="subject_math">ìˆ˜í•™</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="subject_math" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'math_label')">
                            <label for="subject_math" class="file-input-label" id="math_label">ğŸ“„ íŒŒì¼ ì„ íƒ</label>
                        </div>
                    </div>

                    <div class="subject-item">
                        <label for="subject_english">ì˜ì–´</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="subject_english" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'english_label')">
                            <label for="subject_english" class="file-input-label" id="english_label">ğŸ“„ íŒŒì¼ ì„ íƒ</label>
                        </div>
                    </div>

                    <div class="subject-item">
                        <label for="subject_history">í•œêµ­ì‚¬</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="subject_history" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'history_label')">
                            <label for="subject_history" class="file-input-label" id="history_label">ğŸ“„ íŒŒì¼ ì„ íƒ</label>
                        </div>
                    </div>

                    <div class="subject-item">
                        <label for="subject_inquiry">íƒêµ¬ (í†µí•©)</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="subject_inquiry" accept=".csv,.xlsx" onchange="handleFileSelect(this, 'inquiry_label')">
                            <label for="subject_inquiry" class="file-input-label" id="inquiry_label">ğŸ“„ íŒŒì¼ ì„ íƒ</label>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ê°™ì€ ìˆ˜í—˜ë²ˆí˜¸ 2ì¤„ë¡œ ì‘ì„± (íƒêµ¬1, íƒêµ¬2)
                        </small>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="uploadFiles()">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                <button class="btn btn-success" id="processBtn" onclick="processData()">ğŸš€ ì„±ì í‘œ ìƒì„±</button>
                <button class="btn btn-danger" onclick="clearData()">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ -->
        <div class="card" id="filesCard" style="display: none;">
            <h2>ğŸ“¥ ìƒì„±ëœ ì„±ì í‘œ</h2>
            <div id="fileList" class="file-list"></div>
        </div>
    </div>

    <script>
        let uploadedFiles = {};
        let currentOutputDir = '';

        function handleFileSelect(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.textContent = 'âœ… ' + input.files[0].name;
                label.classList.add('has-file');
            } else {
                label.textContent = 'ğŸ“„ íŒŒì¼ ì„ íƒ';
                label.classList.remove('has-file');
            }
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showProgress(percent) {
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progress-bar');
            progress.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        async function uploadFiles() {
            const formData = new FormData();
            
            // í•™ìƒëª… íŒŒì¼ (í•„ìˆ˜)
            const studentNamesFile = document.getElementById('student_names').files[0];
            if (!studentNamesFile) {
                showAlert('í•™ìƒëª… íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            formData.append('student_names', studentNamesFile);

            // ë“±ê¸‰ì»· íŒŒì¼ (ì„ íƒì‚¬í•­)
            const gradeCutoffFile = document.getElementById('grade_cutoff').files[0];
            if (gradeCutoffFile) {
                formData.append('grade_cutoff', gradeCutoffFile);
            }

            // ê³¼ëª© íŒŒì¼ë“¤
            const subjects = ['korean', 'math', 'english', 'history', 'inquiry'];
            let uploadCount = 0;
            
            subjects.forEach(subject => {
                const input = document.getElementById('subject_' + subject);
                if (input.files && input.files[0]) {
                    formData.append('subject_' + subject, input.files[0]);
                    uploadCount++;
                }
            });

            if (uploadCount === 0) {
                showAlert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ê³¼ëª© íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showProgress(0);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                showProgress(50);

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    showProgress(100);
                    setTimeout(hideProgress, 1000);
                } else {
                    const errorMsg = 'âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨\n\n' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') + '\n\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    showAlert(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                    alert(errorMsg);
                    hideProgress();
                }
            } catch (error) {
                const errorMsg = 'âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n' + error.message + '\n\nì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.';
                showAlert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                alert(errorMsg);
                hideProgress();
            }
        }

        async function processData() {
            const pdfTitle = document.getElementById('pdf_title').value;
            const examName = document.getElementById('exam_name').value;

            if (!pdfTitle || !examName) {
                const errorMsg = 'âš ï¸ ì„±ì í‘œ ì œëª©ê³¼ ì‹œí—˜ íšŒì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                showAlert(errorMsg, 'error');
                alert(errorMsg);
                return;
            }

            showProgress(0);
            showAlert('ì„±ì í‘œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pdf_title: pdfTitle,
                        exam_name: examName
                    })
                });

                showProgress(70);

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    currentOutputDir = data.output_dir;
                    displayFileList(data.files, data.output_dir);
                    showProgress(100);
                    setTimeout(hideProgress, 1000);
                } else {
                    const errorMsg = 'âŒ ì„±ì í‘œ ìƒì„± ì‹¤íŒ¨\n\n' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    showAlert(data.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
                    alert(errorMsg);
                    hideProgress();
                }
            } catch (error) {
                const errorMsg = 'âŒ ì„±ì í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n' + error.message + '\n\nì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                showAlert('ì„±ì í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                alert(errorMsg);
                hideProgress();
            }
        }

        function displayFileList(files, outputDir) {
            const filesCard = document.getElementById('filesCard');
            const fileList = document.getElementById('fileList');
            
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">ğŸ“„ ${file}</span>
                    <a href="/download/${outputDir}/${file}" class="download-btn" download>ë‹¤ìš´ë¡œë“œ</a>
                `;
                fileList.appendChild(fileItem);
            });

            filesCard.style.display = 'block';
        }

        async function clearData() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/clear-data', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // í¼ ì´ˆê¸°í™”
                    document.querySelectorAll('input[type="file"]').forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll('.file-input-label').forEach(label => {
                        label.textContent = 'ğŸ“„ íŒŒì¼ ì„ íƒ';
                        label.classList.remove('has-file');
                    });
                    
                    document.getElementById('processBtn').disabled = true;
                    document.getElementById('filesCard').style.display = 'none';
                } else {
                    showAlert(data.error || 'ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

